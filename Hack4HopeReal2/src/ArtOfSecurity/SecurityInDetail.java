package ArtOfSecurity;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.util.ArrayList;

import javax.servlet.http.HttpServletResponse;

import com.sun.xml.internal.messaging.saaj.util.Base64;





/* Created By Nick Stone on 2/2/2020
 * 
 * MODULE COMMENTS: 
 * This module is designed to be implemented by pre-existing Legacy web applications that run on JSP or other older Java Web Frameworks
 * This Package aims to resolve and defend against several security vulnerabilities and exploit attacks. 
 * 
 * We currently defend against: 
 * Contact Nick Stone to work on this open source project
 * */



public class SecurityInDetail 
{

	
    private static final String[] blockTags = {
            "html", "head", "body", "frameset", "script", "noscript", "style", "meta", "link", "title", "frame",
            "noframes", "section", "nav", "aside", "hgroup", "header", "footer", "h1", "h2", "h3", "h4", "h5", "h6",
             "pre", "div", "blockquote", "hr", "address", "figure", "figcaption", "form", "fieldset", 
            "del", "dl", "dt", "dd", "table", "caption", "thead", "tfoot", "tbody", "colgroup", "col",
            "td", "video", "audio", "canvas", "details",  "plaintext", "template", "article", 
            "svg"
    };
    private static final String[] inlineTags = {
            "object", "base", "font", "tt", "big", "small", "em", "strong", "dfn", "code", "samp", "kbd",
            "var", "cite", "abbr", "time", "acronym", "mark", "ruby", "rt", "rp",  "img",  "wbr", "map",
            "sub", "sup", "bdo", "iframe", "embed", "span", "input", "select", "textarea", "label", "button", "optgroup",
            "option", "legend", "datalist", "keygen", "output", "progress", "meter", "area", "param", "source", "track",
            "summary", "command", "device", "area", "basefont", "bgsound", "menuitem", "param", "source", "track",
            "data", "bdi"
    };
    private static final String[] emptyTags = {
            "meta", "link", "base", "frame", "img", "wbr", "embed", "hr", "input", "keygen", "command",
            "device", "area", "basefont", "bgsound", "menuitem", "param", "source", "track"
    };
  
  
    private static final String[] formSubmitTags = {
            "input", "keygen", "object", "select", "textarea"
    };
	//Two methods that branch and combine methods together
	//One for queries and one for non queries
	private static final String[] sqlinje = {
		"select","union", "where", "or", "and", "group", "schema", "table", "alter", "as", "avg","between",
		"case","count","create","delete","group","by", "having","inner","join","outer","insert","null",
		"like","limit", "distinct", "update","with","from"
	}; 
	
	
	//Create a parsing method 

	//SQLInjection

	//This is a SQL Injection Prevention Method
	//Need to Document and Revisit to Refactor:
	public static String parses(String sql) {
		String aa = sql; 
		//String stringtoparse = ""; 
		aa = aa.replaceAll("[@,#,$,%,^,&,*,<,>,/,',:,;',=,+,-]", "");
		aa.toLowerCase();
		String[] Stringgiven = aa.split("\\s+");
		//Parse the commands to 
		ArrayList<String> perm = new ArrayList();
		for(int i = 0; i < Stringgiven.length; i++) {
			
		
		for(int b = 0; b < sqlinje.length; b++) {
			
			perm = permutations(sqlinje[b]); 
			for(int j = 0; j < perm.size();j++) {
				
				if(Stringgiven[i].equals(perm.get(j))) {
					
					Stringgiven[i] = null; 
					Stringgiven[i] = "";		
				}
			}
		}
	}

		aa = "";
		
		for(int fds = 0; fds < Stringgiven.length; fds++) {
			if(Stringgiven[fds].equals("") ) {
				
				
			}
			else {
			
			aa = aa + Stringgiven[fds] + " "; 
			}
			
		}
		
		
		
		//Parse all of the SQL commands out of the String.
		
		
		
		//Then Implement a Secure injection
		
		//System.out.println(aa); 
		return aa; 
	}
	
	
	//JavaScript Injection
	
	public static String parsejavascript(String sanitize) {
		//Write a Regular Expression to parse out all <Script> Tags!
		String bb = sanitize; 
	
		ArrayList<String> gs = new ArrayList<String>(); 
		//Parse all the java script tags
		//TODO Turn this into a regular expression
		
		//Block Tags Permutated
		for(int i = 0; i < blockTags.length; i++) {
			
			gs = permutations(blockTags[i]); 
			for(int j = 0; j < gs.size(); j++) {
				String s = gs.get(j); 
				//System.out.println(s);
				bb = bb.replaceAll(s,""); 
			}
		}
		//Script
		gs = permutations("<script>"); 
		for(int j = 0; j < gs.size(); j++) {
			String s = gs.get(j); 
			//System.out.println(s);
			bb = bb.replaceAll(s,""); 
			
		}
		gs = permutations("</script>"); 
		for(int j = 0; j < gs.size(); j++) {
			String s = gs.get(j); 
			//System.out.println(s);
			bb = bb.replaceAll(s,""); 
			
		}
		for(int i = 0; i < inlineTags.length; i++) {
			
			gs = permutations(inlineTags[i]); 
			for(int j = 0; j < gs.size(); j++) {
				String s = gs.get(j); 
				//System.out.println(s);
				bb = bb.replaceAll(s,""); 
				
			}
		}
		for(int i = 0; i < emptyTags.length; i++) {
			
			gs = permutations(emptyTags[i]); 
			for(int j = 0; j < gs.size(); j++) {
				String s = gs.get(j); 
				//System.out.println(s);
				bb = bb.replaceAll(s,""); 
				
			}
		}
	for(int i = 0; i < formSubmitTags.length; i++) {
		
		gs = permutations(formSubmitTags[i]); 
		for(int j = 0; j < gs.size(); j++) {
			String s = gs.get(j); 
			//System.out.println(s);
			bb = bb.replaceAll(s,""); 
			
		}
	}
		
		
		/*
		bb = bb.replaceAll("<script>", "");
		bb = bb.replaceAll("</script>", "");
		bb = bb.replaceAll("<Script>", "");
		bb = bb.replaceAll("</Script>", "");
		*/
		//Replace all special characters
		bb = bb.replaceAll("[@,#,$,%,^,&,*,<,>,/,',:,;']", "");
		
		
		
		return bb; 
	}
	
	//Cookies to stop Brute Force Log In Attack
	private static void CookieLogs() {
		
		
	}
	
	//Cookies to stop Port SCan? 
	private static void portscan() {
	
	
	}
	 static ArrayList<String> permutations(String attack) 
	    { 
		 	ArrayList<String> t = new ArrayList(); 
	        int lengthstring = attack.length();
	        double max = Math.pow(2, lengthstring); 
	        attack = attack.toLowerCase();  
	        int i = 0; 
	        while(i < max){
	            char stri[] = attack.toCharArray(); 
	            int j = 0; 
	            while(j < lengthstring){
	                if(((i >> j) &  1) == 1) 
	                {
	                    stri[j] = (char) (stri[j]-32); 
	                }
	                j++; 
	            }  
	            //System.out.println(stri); 
	            String fsd = String.valueOf(stri); 
	            t.add(fsd);   
	            i++;
	            continue; 
	        } 
	        return t; 
	    } 
	
	 
	 //On Initialization what should we do? make a cookie? 
	public static void init() {
		
		
	}
	
		//Testing
	public static void NetworkError(HttpServletResponse response) throws IOException {
		
		try {
			int s = response.getStatus(); 
			if(s > 200) {
				//Not ok
				response.sendRedirect("FileNotFound.jsp");
				//return false; 
			}
		
		}
		catch(Exception e){
			response.sendRedirect("FileNotFound.jsp");
		}
		//Ok
		//return true; 
		
		
	}
	
	//Log an entry?
	public static void Log(HttpServletResponse s)throws IOException {
		
		
		
	}
		
	//Change to SHA 256
	public static void Updatehash(String hash){
		
		//Write a Query to pull all of the users from the database
		
		
		
	}
	
	//New Authentication 
	public static boolean NewAuthentication(String Hash){
		try{
		MessageDigest digest = MessageDigest.getInstance("SHA-256");
		byte[] hash = digest.digest(Hash.getBytes(StandardCharsets.UTF_8));
		System.out.println("This is the Hash\n"); 
		System.out.println(hash); 
		
		}
		catch (Exception e){
			
			System.out.println(e);
			
		}
		
		return false; 
	}
	
	// New Authentication to sha256
	
	
}
